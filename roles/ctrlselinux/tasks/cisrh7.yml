---
# tasks file for roles/selinux/cisrh7
#-------------------------------------------
- name: Enable SELinux
  selinux:
    policy: targeted
    state: enforcing
  tags:
    - selinux_state
    - high_severity
    - restrict_strategy
    - low_complexity
    - low_disruption
    - no_reboot_needed
    - CCE-27334-2
  register: resultat
# display TASK result
- debug:
    msg: "RESULTAT: {{ resultat.state }}"
# copy result to local file 
- local_action: copy content="{{ resultat.state }}" dest="~/output.txt"
# copy result on every destination host into /tmp/output.txt
- copy: content="{{ resultat.state }}" dest="/tmp/output.txt"   # delegate_to: localhost
#-------------------------------------------
- name: "Ensure mcstrans is removed"
  package:
    name: mcstrans
    state: absent
  tags:
    - package_mcstrans_removed
    - unknown_severity
    - disable_strategy
    - low_complexity
    - low_disruption
    - no_reboot_needed
    - CCE-80445-0
  register: resultat
- debug:
    msg: "RESULTAT: {{ resultat.results }}"
#-------------------------------------------
- name: Ensure setroubleshoot is removed
  package:
    name: setroubleshoot
    state: absent
  tags:
    - package_setroubleshoot_removed
    - unknown_severity
    - disable_strategy
    - low_complexity
    - low_disruption
    - no_reboot_needed
    - CCE-80444-3
  register: resultat
- debug:
    msg: "RESULTAT: {{ resultat.results }}"
#-------------------------------------------
- name: Ensure SELinux Not Disabled in /etc/default/grub
  replace:
    dest: /etc/default/grub
    regexp: selinux=0
  tags:
    - grub2_enable_selinux
    - medium_severity
    - restrict_strategy
    - low_complexity
    - low_disruption
    - no_reboot_needed
    - CCE-26961-3
  register: resultat
- debug:
    msg: "RESULTAT: changed = {{ resultat.changed }}"
#-------------------------------------------
- name: XCCDF Value var_selinux_policy_name # promote to variable
  set_fact:
    var_selinux_policy_name: !!str targeted
  tags:
    - always
- name: Configure SELinux Policy
  lineinfile:
    path: /etc/sysconfig/selinux
    regexp: ^SELINUXTYPE=
    line: SELINUXTYPE={{ var_selinux_policy_name }}
    create: true
  tags:
    - selinux_policytype
    - high_severity
    - restrict_strategy
    - low_complexity
    - low_disruption
    - no_reboot_needed
    - CCE-27279-9
  register: resultat
- debug:
    msg: "RESULTAT: changed = {{ resultat.changed }}"
#-------------------------------------------
- name: XCCDF Value var_selinux_state # promote to variable
  set_fact:
    var_selinux_state: !!str enforcing
  tags:
    - always

- name: Ensure SELinux State is Enforcing
  lineinfile:
    path: /etc/sysconfig/selinux
    regexp: ^SELINUX=
    line: SELINUX={{ var_selinux_state }}
    create: true
  tags:
    - selinux_state
    - high_severity
    - restrict_strategy
    - low_complexity
    - low_disruption
    - no_reboot_needed
    - CCE-27334-2
  register: resultat
- debug:
    msg: "RESULTAT: changed = {{ resultat.changed }}"
#-------------------------------------------